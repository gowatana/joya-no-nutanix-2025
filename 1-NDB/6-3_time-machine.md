# 6-3. NDBのタイムマシン

NDB では、DB のスナップショットやバックアップ/リストア、クローンによる Copy Data Management（CDM）機能のために、タイムマシンと呼ばれるコンポーネントを利用します。

NBD の Copy Data Management（CDM）機能では、

タイムマシンは、ソース DB を登録またはプロビジョニングする際に、DB 単位で必ず作成することになります。


## 主な機能

タイムマシンでは、下記の機能を提供しています。
- スナップショットの取得
- ログのキャッチアップ
- DB のバックアップ / リストア
‐ クローン DB の作成
- SLA ポリシー
- スケジュール設定


## スナップショットの取得

NDB 側で管理されるスナップショットです。NDB UI で DB と同時に作成されたタイムマシンには、自動的に最初のスナップショット（era_auto_snapshot）が作成されます。

NDB のスナップショットには Nutanix HCI の Protection Domain スナップショットが活用されていますが、作成や削除は NDB から実施されます。

下記のスクリーンショットでは、NDB のタイムマシンに9件のスナップショットが作成されています。


これは、Prism Element では保護ドメインのスナップショットです。

NDB によるスナップショットは、アプリケーションの整合性を意識して取得されます。たとえば Oracle Database であればバックアップ モードに切り替えて取得されるので、アーカイブログ モードが有効化されていないと取得が失敗します。


## ログのキャッチアップ

NDB によって、定期的に DB のログがキャッチアップされます。
このログは DB の更新を記録するもので、PostgreSQL の WAL ログ、Oracle Database の REDO ログ、SQL Server のトランザクション ログなどを指します。

ログのキャッチアップは、手動で開始することもできます。

3rd-Party の（NDB 以外の）バックアップ ソフトウェアでも DB をバックアップする場合、バックアップ完了後に DB のログを削除することがあります。そういったバックアップ処理と NDB を併用する場合は、3rd-Party によるバックアップ処理の開始前に NDB のログ キャッチアップが実施されるように考慮しておきましょう。

NDB のタイムマシンでは、スナップショットとログのキャッチアップを併用して実現されています。

> DB でログ キャッチアップが実行できない（グレーアウトされている）場合には、タイムマシンに割り当てられている SLA ポリシーが「継続的なログの保存期間」の日数が設定されたものであることを確認します。


## SLA ポリシー

タイムマシンでは、スナップショットとログの定期的な取得と保持期間の管理を SLA というポリシーで定義します。

SLA は、デフォルトで下記のものが用意されていますが、追加作成もできます。保持期限は、日時、週次、月次、四半期での指定が可能です。


ログのキャッチアップと、ポイント イン タイム（PIT）のクローン/リカバリを実施するには、SLA で「連続」（のログキャッチアップ）の日数が指定されている必要があります。


> SLA のタイムマシンへの割り当ては、タイムマシンの作成後でも変更可能です。しかし SLA 割り当てを変更すると、それまでに取得された DB のスナップショットやログが削除されてしまうので、変更以前のスナップショット/リストアによるリストアやクローン処理が実施できなくなります。

## スケジュール設定

スナップショットの取得は、スケジュール設定できます。


## 参考情報1: タイムマシンによる DB 管理の補足（Oracle Database の場合）

たとえば Oracle Database の場合、DB は下記のようなファイルで構成されます。

障害発生時もデータの整合性を保つため、REDOログとデータは、別のタイミングで書き出されます。

そして、データの書き出しのみを静止することで、オンライン バックアップできるようになっています。

このとき REDOログ ファイルの書き出しは継続されており、アーカイブログ モードになっている必要があります。そのため、NDB で管理される Oracle Database もアーカイブログ モードに設定されている必要があります。


## 参考情報2: タイムマシンによるデータ管理の詳細（Oracle Database Single Instance の場合）

タイムマシンによるデータ管理では、スナップショットとログ キャッチアップが併用されています。これは、DB サーバー VM / DB のコンポーネントごとに使い分けられています。

NDB によってプロビジョニングでは、タイムマシンで扱いやすいディスク構成で DB サーバ　VM が作成され、ゲスト OS 側でも VG / LV / ファイルシステムが作成ます。

そして下記のように構成で、DBMS ソフトウェア / DB 構成ファイルが配置されます。

> - [Blog] NDB で作成した Oracle Database の様子。（Single Instance DB Server VM - vDisk 編）    
>   https://blog.ntnx.jp/entry/2023/02/28/235802


# 参考ドキュメント
